;(function($, undefined) {
	function _init(){
	    //_initialization();
	    _createRoom();
		//_addEvents();
	}
	/*
	 * 默认加载的数据（roomserver数据）
	 */
	function _initialization(){
		//首先加载服务器的信息房间列表等数据
		$.get(_serverUrl+'getAllRooms').
		    success(function (data, status, headers, config) {
		        _scope.listRooms = data;
		    }).
		    error(function (data, status, headers, config) {});
		$.get(_serverUrl+'getClientConfig').
		     success(function (data, status, headers, config) {
		    	_scope.clientConfig = data;
		     }).
		     error(function (data, status, headers, config) {});
		$.get(_serverUrl+'getUpdateSpeakerInterval').
			success(function (data, status, headers, config) {
				_scope.updateSpeakerInterval = data
			}).
			error(function (data, status, headers, config) {});
		$.get(_serverUrl+'getThresholdSpeaker').
			success(function (data, status, headers, config) {
				_scope.thresholdSpeaker = data
			}).
			error(function (data, status, headers, config) {});
	}
	/*
	 * 创建房间
	 */
	function _createRoom(){
		var _userArray = [];
		var _userName = randomString(6);
	    var _roomName = _roomId || randomNumber(6);
	    var wsUri = _socketServer;
	    //show loopback stream from server
	    var displayPublished = false;
	    //also show local stream when display my remote
	    var mirrorLocal = false;
	    var kurento = KurentoRoom(wsUri, function (error, kurento) {
	        if (error)
	            return console.log(error);
	        //TODO token should be generated by the server or a 3rd-party component  
	        //kurento.setRpcParams({token : "securityToken"});
	        room = kurento.Room({
	            room: _roomName,
	            user: _userName,
	            updateSpeakerInterval: 1800,
	            thresholdSpeaker: -50 
	        });

	        var localStream = kurento.Stream(room, {
	            audio: true,
	            video: true,
	            data: false
	        });
			$("#addperson").on("click", function(){
				localStream.init();
			});

	        //加入房间成功
	        localStream.addEventListener("access-accepted", function (stream) {
				//if(!!stream){
				//	console.log("haha_stream"+URL.createObjectURL(stream.getWrStream()));
				//}
	        	$('#userid').attr('title',_userName);
	        	if(!_roomId){
	        		setRoomUrl(_ServiceRoom.getRoomName());//如果是创建那么修改url
	        	}
	        	//连接房间
	            room.addEventListener("room-connected", function (roomEvent) {
	            	_userArray.push(_userName);
	            	var participants = roomEvent.participants;
	            	for (var i = 0; i < participants.length; i++) {
	            		var uid = participants[i].getID();
	            		_userArray.push(uid);
	            	}
	            	
	            	ttttt = $("#content").LY({el:'#content', status:'1', streams:[], uids: _userArray});

	            	//掉单总传给他uids数组_userArray
	            	
	            	console.log('=========',_userArray,'=-=====');
//	            	var streams = roomEvent.streams;
//	            	console.log(roomEvent);
//	            	if (displayPublished ) {
//	            		localStream.subscribeToMyRemote();
//	            	}
	            	localStream.publish();
//	            	_ServiceRoom.setLocalStream(localStream.getWebRtcPeer());
//	                for (var i = 0; i < streams.length; i++) {
//	                	var globaid = streams[i].getID();
//	                	participants_videos[globaid] = {};
	                	//console.log('streagetGlobalID:::43434::::::::'+streams[i].getGlobalID());
//	                	_ServiceParticipant.addParticipant(streams[i],function(srec){
//	                		console.log('0000----------videosrc::::::'+srec);
//	                	});
////						var stream = streams[i];
////						setTimeout(function(){
////							//console.log("haha_stream"+URL.createObjectURL(stream.getWrStream()));
////						},1000);
//	                }
	            });
	            /*
	             * 获取流
	             */
	            room.addEventListener("stream-subscribed", function (stream) {
	            	var userstream = {};
	            	userstream.uid = stream.stream.getUserID();
	            	userstream.src = stream.stream.getUrl();
	            	//调单总传 uid和流userstream
	            	ttttt.LY('addUser', userstream);
	            	console.log('-------------');
	            	console.log(userstream);
	            	console.log('-------------');
				});
	            
	            //假如房间推送的流集合
	            room.addEventListener("stream-published", function (streamEvent) {
	            	var userstream = {};
	            	userstream.uid = streamEvent.stream.getUserID();
	            	userstream.src = streamEvent.stream.getUrl();
	            	//调单总传 uid和流userstream
	            	console.log('-------------');
	            	console.log(userstream);
	            	console.log('-------------');
	            	
	            	ttttt.LY('addUser', userstream);
//                    _ServiceParticipant.addLocalParticipant(localStream);
//					if (mirrorLocal && localStream.displayMyRemote()) {
//						var localVideo = kurento.Stream(room, {
//							video: true,
//							id: "localStream"
//						});
//						localVideo.mirrorLocalStream(localStream.getWrStream());
//						_ServiceParticipant.addLocalMirror(localVideo);
//					}
	            });
	           //清楚流
	            room.addEventListener("stream-removed", function (streamEvent) {console.log('---4---');
	            	_ServiceParticipant.removeParticipantByStream(streamEvent.stream);
	            });
	            
	            //视频流加入
	            room.addEventListener("stream-added", function (streamEvent) {console.log('---3---',streamEvent);
	            	// _ServiceParticipant.addParticipant(streamEvent.stream,function (src){
	            	// 	console.log('111111111111-------:::'+src);
	            	// });
	            });
	            
	            //新消息
	            room.addEventListener("newMessage", function (msg) {console.log('---5---');
	            	_ServiceParticipant.showMessage(msg.room, msg.user, msg.message);
	            });
	            //房间错误
	            room.addEventListener("error-room", function (error) {console.log('---6---',error);
	            	//error  code=104该用户已经在房间内了
	            	//error  code=804参与者过多
	            	_ServiceParticipant.showError(window, LxNotificationService, error);
	            });
	            //错误的媒体
	            room.addEventListener("error-media", function (msg) {console.log('---7---');
	            	_ServiceParticipant.alertMediaError($window, LxNotificationService, msg.error, function (answer) {
	                	console.warn("Leave room because of error: " + answer);
	                	if (answer) {
	                		kurento.close(true);
	                	}
	                });
	            });
	            //房间封闭
	            room.addEventListener("room-closed", function (msg) {console.log('---8---');
	            	if (msg.room !== _roomName) {
	            		console.error("Closed room name doesn't match this room's name", 
	            				msg.room, _roomName);
	            	} else {
	            		kurento.close(true);
	            		_ServiceParticipant.forceClose($window, LxNotificationService, 'Room '
	            			+ msg.room + ' has been forcibly closed from server');
	            	}
	            });
	            //失去连接
	            room.addEventListener("lost-connection", function(msg) {console.log('---9---');
	                kurento.close(true);
	                // _ServiceParticipant.forceClose($window, LxNotificationService,
	                //   'Lost connection with room "' + msg.room +
	                //   '". Please try reloading the webpage...');
	              });
	            //停止声音流
	            room.addEventListener("stream-stopped-speaking", function (participantId) {console.log('---10---');
	            	_ServiceParticipant.streamStoppedSpeaking(participantId);
	             });
	            //声音流
	             room.addEventListener("stream-speaking", function (participantId) {console.log('---11---');
	            	 _ServiceParticipant.streamSpeaking(participantId);
	             });
	             //跟新主要发言人
	             room.addEventListener("update-main-speaker", function (participantId) {
	            	 _ServiceParticipant.updateMainSpeaker(participantId);
	              });
				//参与者加入
				room.addEventListener("participant-joined", function (participant) {
					//_ServiceParticipant.updateMainSpeaker(participantId);
				});
				//远程流
				room.addEventListener("stream-subscribed", function (stream) {
					// _ServiceParticipant.addParticipant(stream.stream,function (src){
					// 	console.log('join'+src);
					// });
					console.log("join_stream :"+stream.stream.getUrl());
				});
	            room.connect();
	        });
	        //拒绝访问
	        localStream.addEventListener("access-denied", function () {console.log('---000---');
	        	_ServiceParticipant.showError($window, LxNotificationService, {
	        		error : {
	        			message : "Access not granted to camera and microphone"
	        				}
	        	});
	        });
	        localStream.init();
	    });
	
	    //save kurento & roomName & userName in service
	    _ServiceRoom.setKurento(kurento);
	    _ServiceRoom.setRoomName(_roomName);
	    _ServiceRoom.setUserName(_userName);
	    //redirect to call
	    //window.location.href = '#call';
		//_createcall();
	}
	
	
	/*
	 * 房间事件绑定
	 */
	function _addEvents(){
		
		var _roomName = _ServiceRoom.getRoomName();
	    var _userName = _ServiceRoom.getUserName();
	    var _participants = _ServiceParticipant.getParticipants();
	    var _kurento = _ServiceRoom.getKurento();
		//离开房间
	    $scope.leaveRoom = function () {

	    	_ServiceRoom.getKurento().close();

	    	_ServiceParticipant.removeParticipants();

	        //redirect to login
	        window.location.href = '#/login';
	    };

	    window.onbeforeunload = function () {
	    	//not necessary if not connected
	    	if (_ServiceParticipant.isConnected()) {
	    		_ServiceRoom.getKurento().close();
	    	}
	    };

			//全拼
	    $scope.goFullscreen = function () {

	        if (Fullscreen.isEnabled())
	            Fullscreen.cancel();
	        else
	            Fullscreen.all();

	    };
	    //禁用主扬声器
	    $scope.disableMainSpeaker = function (value) {

	    	var element = document.getElementById("buttonMainSpeaker");
	        if (element.classList.contains("md-person")) { //on
	            element.classList.remove("md-person");
	            element.classList.add("md-recent-actors");
	            _ServiceParticipant.enableMainSpeaker();
	        } else { //off
	            element.classList.remove("md-recent-actors");
	            element.classList.add("md-person");
	            _ServiceParticipant.disableMainSpeaker();
	        }
	    };
			//开关音量
	    $scope.onOffVolume = function () {
	        var localStream = _ServiceRoom.getLocalStream();
	        var element = document.getElementById("buttonVolume");
	        if (element.classList.contains("md-volume-off")) { //on
	            element.classList.remove("md-volume-off");
	            element.classList.add("md-volume-up");
	            localStream.audioEnabled = true;
	        } else { //off
	            element.classList.remove("md-volume-up");
	            element.classList.add("md-volume-off");
	            localStream.audioEnabled = false;

	        }
	    };
			//打开关闭摄像头
	    $scope.onOffVideocam = function () {
	        var localStream = _ServiceRoom.getLocalStream();
	        var element = document.getElementById("buttonVideocam");
	        if (element.classList.contains("md-videocam-off")) {//on
	            element.classList.remove("md-videocam-off");
	            element.classList.add("md-videocam");
	            localStream.videoEnabled = true;
	        } else {//off
	            element.classList.remove("md-videocam");
	            element.classList.add("md-videocam-off");
	            localStream.videoEnabled = false;
	        }
	    };
			//断开流
	    $scope.disconnectStream = function() {
	    	var localStream = _ServiceRoom.getLocalStream();
	    	var participant = _ServiceParticipant.getMainParticipant();
	    	if (!localStream || !participant) {
	    		LxNotificationService.alert('Error!', "Not connected yet", 'Ok', function(answer) {
	            });
	    		return false;
	    	}
	    	_ServiceParticipant.disconnectParticipant(participant);
	    	_ServiceRoom.getKurento().disconnectParticipant(participant.getStream());
	    };
	    
	    //聊天
	    $scope.message;
			//发送消息
	    $scope.sendMessage = function () {
	        console.log("Sending message", $scope.message);
	        var kurento = _ServiceRoom.getKurento();
	        kurento.sendMessage(_roomName, _userName, $scope.message);
	        $scope.message = "";
	    };

	    //打开或关闭聊天时，点击“聊天”按钮
	    $scope.toggleChat = function () {
	        var selectedEffect = "slide";
	        // most effect types need no options passed by default
	        var options = {direction: "right"};
	        if ($("#effect").is(':visible')) {
	            $("#content").animate({width: '100%'}, 500);
	        } else {
	            $("#content").animate({width: '80%'}, 500);
	        }
	        // run the effect
	        $("#effect").toggle(selectedEffect, options, 500);
	    };
	    //显示帽子
	    $scope.showHat = function () {
	    	var targetHat = false;
	    	var offImgStyle = "md-mood";
	    	var offColorStyle = "btn--deep-purple";
	    	var onImgStyle = "md-face-unlock";
	    	var onColorStyle = "btn--purple";
	    	var element = document.getElementById("hatButton");
	        if (element.classList.contains(offImgStyle)) { //off
	            element.classList.remove(offImgStyle);
	            element.classList.remove(offColorStyle);
	            element.classList.add(onImgStyle);
	            element.classList.add(onColorStyle);
	            targetHat = true;
	        } else if (element.classList.contains(onImgStyle)) { //on
	            element.classList.remove(onImgStyle);
	            element.classList.remove(onColorStyle);
	            element.classList.add(offImgStyle);
	            element.classList.add(offColorStyle);
	            targetHat = false;
	        }
	    	
	        var hatTo = targetHat ? "on" : "off";
	    	console.log("Toggle hat to " + hatTo);
	    	_ServiceRoom.getKurento().sendCustomRequest({hat: targetHat}, function (error, response) {
	    		if (error) {
	                console.error("Unable to toggle hat " + hatTo, error);
	                LxNotificationService.alert('Error!', "Unable to toggle hat " + hatTo, 
	                		'Ok', function(answer) {});
	        		return false;
	            } else {
	            	console.debug("Response on hat toggle", response);
	            }
	    	});
	    };
	}
	/*
	 * 创建房间修改url
	 * roomid 房间的id
	 */
	function setRoomUrl(urlParameter){
		if(!urlParameter){
			return false;
		}
		//setTimeout(function (){
		history.replaceState({},"joinroom","/"+urlParameter);
		//},5000)
	}
	
	/*
	 * 随机生成字符串  len 字符串长度默认32位
	 */
	function randomString(len){
		len = len || 32;
		var chars = 'abcdefhijkmnprstwxyz';
		var maxPos = chars.length;
		var str = '';
		for (i = 0; i < len; i++) {
			str += chars.charAt(Math.floor(Math.random() * maxPos));
		}
		return str;
	}
	function randomNumber(len){
		len = len || 32;
		var chars = '123456789';
		var maxPos = chars.length;
		var str = '';
		for (i = 0; i < len; i++) {
			str += chars.charAt(Math.floor(Math.random() * maxPos));
		}
		return str;
	}
	_init();
})(window.jQuery);